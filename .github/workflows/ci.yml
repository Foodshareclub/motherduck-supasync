# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                     ðŸ¦† MotherDuck Sync - CI & Publish                        â•‘
# â•‘                                                                              â•‘
# â•‘  Pipeline Flow:                                                              â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â•‘
# â•‘  â”‚ Gate    â”‚â”€â”€â–¶â”‚ Quality (parallel)                           â”‚              â•‘
# â•‘  â”‚ â€¢ stale â”‚   â”‚ â€¢ format â€¢ lint â€¢ build â€¢ test â€¢ docs        â”‚              â•‘
# â•‘  â”‚ â€¢ secretsâ”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚                                          â•‘
# â•‘                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â•‘
# â•‘                    â–¼                             â–¼                           â•‘
# â•‘              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â•‘
# â•‘              â”‚ Security â”‚                 â”‚ Package  â”‚                       â•‘
# â•‘              â”‚ â€¢ audit  â”‚                 â”‚ â€¢ verify â”‚                       â•‘
# â•‘              â”‚ â€¢ 7 scansâ”‚                 â”‚ â€¢ dry-runâ”‚                       â•‘
# â•‘              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â•‘
# â•‘                    â”‚                             â”‚                           â•‘
# â•‘                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â•‘
# â•‘                                   â–¼                                          â•‘
# â•‘                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â•‘
# â•‘                            â”‚  Publish   â”‚ (main branch only)                 â•‘
# â•‘                            â”‚  crates.io â”‚                                    â•‘
# â•‘                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CI & Publish

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-A missing_docs"
  RUST_BACKTRACE: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: Gate - Fast checks before expensive operations
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gate:
    name: ðŸš¦ Gate
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: ðŸ›‘ Cancel stale runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
          all_but_latest: true

      - name: ðŸ”‘ Validate secrets
        id: check
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ðŸ”‘ Secrets Configuration               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          check_secret() {
            local name=$1
            local value=$2
            local required=$3
            if [ -n "$value" ]; then
              echo "  âœ… $name"
              return 0
            else
              if [ "$required" = "true" ]; then
                echo "  âŒ $name (required)"
                return 1
              else
                echo "  âš ï¸  $name (optional)"
                return 0
              fi
            fi
          }
          
          echo ""
          FAILED=0
          
          check_secret "CARGO_REGISTRY_TOKEN" "${{ secrets.CARGO_REGISTRY_TOKEN }}" "true" || FAILED=1
          check_secret "MOTHERDUCK_TOKEN" "${{ secrets.MOTHERDUCK_TOKEN }}" "false"
          check_secret "DATABASE_URL" "${{ secrets.DATABASE_URL }}" "false"
          check_secret "SYNC_TABLES_CONFIG" "${{ secrets.SYNC_TABLES_CONFIG }}" "false"
          
          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "ðŸ“ Configure at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: Quality - Parallel code quality checks
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  format:
    name: ðŸŽ¨ Format
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --check

  lint:
    name: ðŸ“Ž Lint
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-targets -- -D warnings

  build:
    name: ðŸ”¨ Build
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo build --release
      - uses: actions/upload-artifact@v4
        with:
          name: binary-${{ github.sha }}
          path: target/release/motherduck-sync
          retention-days: 7

  test:
    name: âœ… Test
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --all-features --no-fail-fast

  docs:
    name: ðŸ“š Docs
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo doc --no-deps
        env:
          RUSTDOCFLAGS: "-A missing_docs -D warnings"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: Security - Comprehensive categorized scanning
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  # 3a. Dependency vulnerability audit
  audit:
    name: ðŸ” Audit Dependencies
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Install cargo-audit
        run: cargo install cargo-audit --locked 2>/dev/null || true
      - name: Run audit
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘        ðŸ” Dependency Vulnerability Audit         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          cargo audit 2>&1 || echo "âš ï¸ Review vulnerabilities above"

  # 3b. AWS credentials scan
  scan-aws:
    name: ðŸ”‘ Scan AWS
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Scan for AWS credentials
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘             ðŸ”‘ AWS Credentials Scan              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          FOUND=0
          
          echo "ðŸ” AWS Access Key IDs (AKIA...)..."
          if grep -rE "AKIA[0-9A-Z]{16}" --include="*.rs" --include="*.toml" . 2>/dev/null; then
            echo "  âŒ AWS Access Key ID found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” AWS Secret Access Keys..."
          if grep -rE "aws_secret_access_key\s*=\s*['\"][A-Za-z0-9/+=]{40}['\"]" --include="*.rs" --include="*.toml" . 2>/dev/null; then
            echo "  âŒ AWS Secret Access Key found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          [ $FOUND -eq 0 ] && echo "âœ… AWS scan passed" || { echo "âŒ AWS credentials detected"; exit 1; }

  # 3c. Database credentials scan
  scan-database:
    name: ðŸ—„ï¸ Scan Database
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Scan for database credentials
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ðŸ—„ï¸ Database Credentials Scan           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          SAFE="localhost|127\.0\.0\.1|example\.com|your_|placeholder|test_db|//!|///|#|\.example"
          FOUND=0
          
          echo "ðŸ” PostgreSQL connection strings..."
          MATCHES=$(grep -rE "postgres(ql)?://[^@]+@[^/]+\.(com|io|net|org|cloud|supabase)" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES" | head -3
            echo "  âŒ PostgreSQL credentials found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” MySQL connection strings..."
          MATCHES=$(grep -rE "mysql://[^@]+@[^/]+\.(com|io|net|org)" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES" | head -3
            echo "  âŒ MySQL credentials found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” MongoDB connection strings..."
          MATCHES=$(grep -rE "mongodb(\+srv)?://[^@]+@[^/]+\.(com|io|net|org)" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES" | head -3
            echo "  âŒ MongoDB credentials found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          [ $FOUND -eq 0 ] && echo "âœ… Database scan passed" || { echo "âŒ Database credentials detected"; exit 1; }

  # 3d. API tokens scan
  scan-tokens:
    name: ðŸŽ« Scan Tokens
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Scan for API tokens
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              ðŸŽ« API Tokens Scan                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          SAFE="your_|example|placeholder|test|//!|///|#|\.example|_token_here"
          FOUND=0
          
          echo "ðŸ” JWT tokens..."
          MATCHES=$(grep -rE "eyJ[a-zA-Z0-9_-]{20,}\.eyJ[a-zA-Z0-9_-]{20,}\.[a-zA-Z0-9_-]{20,}" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES" | head -3
            echo "  âŒ JWT token found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” GitHub tokens..."
          if grep -rE "(ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9_]{36,}" --include="*.rs" --include="*.toml" . 2>/dev/null; then
            echo "  âŒ GitHub token found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” Slack tokens..."
          if grep -rE "xox[baprs]-[0-9]{10,}-[0-9]{10,}-[a-zA-Z0-9]{24,}" --include="*.rs" --include="*.toml" . 2>/dev/null; then
            echo "  âŒ Slack token found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” Stripe keys..."
          if grep -rE "(sk|pk)_(live|test)_[a-zA-Z0-9]{24,}" --include="*.rs" --include="*.toml" . 2>/dev/null; then
            echo "  âŒ Stripe key found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          [ $FOUND -eq 0 ] && echo "âœ… Tokens scan passed" || { echo "âŒ API tokens detected"; exit 1; }


  # 3e. Private keys scan
  scan-keys:
    name: ðŸ” Scan Keys
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Scan for private keys
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘             ðŸ” Private Keys Scan                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          FOUND=0
          
          echo "ðŸ” RSA/EC/DSA private keys..."
          if grep -rE "-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----" --include="*.rs" --include="*.toml" --include="*.pem" --include="*.key" . 2>/dev/null; then
            echo "  âŒ Private key found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” PGP private keys..."
          if grep -rE "-----BEGIN PGP PRIVATE KEY BLOCK-----" --include="*.rs" --include="*.toml" --include="*.asc" . 2>/dev/null; then
            echo "  âŒ PGP private key found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          [ $FOUND -eq 0 ] && echo "âœ… Keys scan passed" || { echo "âŒ Private keys detected"; exit 1; }

  # 3f. Cloud provider secrets scan
  scan-cloud:
    name: â˜ï¸ Scan Cloud
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Scan for cloud provider secrets
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          â˜ï¸ Cloud Provider Secrets Scan          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          SAFE="your_|example|placeholder|test|//!|///|#|\.example"
          FOUND=0
          
          echo "ðŸ” GCP service account keys..."
          if grep -rE '"type"\s*:\s*"service_account"' --include="*.json" --include="*.rs" . 2>/dev/null | grep -vE "$SAFE"; then
            echo "  âŒ GCP service account key found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” Azure connection strings..."
          MATCHES=$(grep -rE "DefaultEndpointsProtocol=https;AccountName=[^;]+;AccountKey=[A-Za-z0-9+/=]{86,}" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES" | head -3
            echo "  âŒ Azure connection string found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” Supabase service keys..."
          MATCHES=$(grep -rE "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9\.[A-Za-z0-9_-]{100,}" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES" | head -3
            echo "  âŒ Supabase key found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” MotherDuck tokens..."
          MATCHES=$(grep -rE 'md_[a-zA-Z0-9_-]{30,}' --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES" | head -3
            echo "  âŒ MotherDuck token found!"
            FOUND=1
          else
            echo "  âœ… None found"
          fi
          
          [ $FOUND -eq 0 ] && echo "âœ… Cloud scan passed" || { echo "âŒ Cloud secrets detected"; exit 1; }

  # 3g. High-entropy strings scan (warnings only)
  scan-entropy:
    name: ðŸŽ² Scan Entropy
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Scan for high-entropy strings
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ðŸŽ² High-Entropy Strings Scan             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          SAFE="your_|example|placeholder|test|//!|///|#|\.example|localhost|127\.0\.0\.1"
          
          echo "ðŸ” Suspicious API key patterns..."
          MATCHES=$(grep -rE "(api_key|apikey|secret|password|token)\s*[=:]\s*['\"][A-Za-z0-9+/=_-]{32,}['\"]" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES" | head -5
            echo "  âš ï¸ Potential secrets (review manually)"
          else
            echo "  âœ… None found"
          fi
          
          echo "ðŸ” Hardcoded passwords..."
          MATCHES=$(grep -rE "password\s*[=:]\s*['\"][^'\"]{8,}['\"]" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" || true)
          if [ -n "$MATCHES" ]; then
            echo "$MATCHES" | head -5
            echo "  âš ï¸ Potential passwords (review manually)"
          else
            echo "  âœ… None found"
          fi
          
          echo "âœ… Entropy scan completed (warnings only)"

  # Security summary
  security:
    name: ðŸ” Security
    needs: [audit, scan-aws, scan-database, scan-tokens, scan-keys, scan-cloud, scan-entropy]
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Security summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ðŸ” Security Scan Summary               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "All security scans completed:"
          echo "  âœ… Dependency vulnerability audit"
          echo "  âœ… AWS credentials scan"
          echo "  âœ… Database credentials scan"
          echo "  âœ… API tokens scan"
          echo "  âœ… Private keys scan"
          echo "  âœ… Cloud provider secrets scan"
          echo "  âœ… High-entropy strings scan"


  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: Package - After quality passes (parallel with security)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  package:
    name: ðŸ“¦ Package
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Verify package
        run: |
          echo "â•â•â• Package Contents â•â•â•"
          cargo package --list
          echo ""
          echo "â•â•â• Dry-run Publish â•â•â•"
          cargo publish --dry-run

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: Publish - Only on main branch after all checks pass
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish:
    name: ðŸš€ Publish
    needs: [gate, security, package, docs]
    if: needs.gate.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: crates-io
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: ðŸ“¤ Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ðŸš€ Publishing to crates.io               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          OUTPUT=$(cargo publish 2>&1) || true
          echo "$OUTPUT"
          
          if echo "$OUTPUT" | grep -q "already uploaded"; then
            echo "âœ… Version already published"
          elif echo "$OUTPUT" | grep -q "Uploading"; then
            echo "âœ… Published: https://crates.io/crates/motherduck-sync"
          else
            echo "âŒ Publish failed"
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: Summary - Always runs
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ðŸ“Š Summary
    needs: [gate, format, lint, build, test, docs, security, package]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ¦† MotherDuck Sync CI
          
          | Stage | Job | Status |
          |-------|-----|--------|
          | Gate | ðŸš¦ Gate | ${{ needs.gate.result == 'success' && 'âœ…' || 'âŒ' }} |
          | Quality | ðŸŽ¨ Format | ${{ needs.format.result == 'success' && 'âœ…' || needs.format.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Quality | ðŸ“Ž Lint | ${{ needs.lint.result == 'success' && 'âœ…' || needs.lint.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Quality | ðŸ”¨ Build | ${{ needs.build.result == 'success' && 'âœ…' || needs.build.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Quality | âœ… Test | ${{ needs.test.result == 'success' && 'âœ…' || needs.test.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Quality | ðŸ“š Docs | ${{ needs.docs.result == 'success' && 'âœ…' || needs.docs.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Security | ðŸ” Security | ${{ needs.security.result == 'success' && 'âœ…' || needs.security.result == 'skipped' && 'â­ï¸' || 'âš ï¸' }} |
          | Package | ðŸ“¦ Package | ${{ needs.package.result == 'success' && 'âœ…' || needs.package.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          
          ### ðŸ” Security Scans
          
          | Category | Description |
          |----------|-------------|
          | ðŸ” Audit | Dependency vulnerabilities (cargo-audit) |
          | ðŸ”‘ AWS | Access keys, secret keys |
          | ðŸ—„ï¸ Database | PostgreSQL, MySQL, MongoDB URLs |
          | ðŸŽ« Tokens | JWT, GitHub, Slack, Stripe |
          | ðŸ” Keys | RSA, EC, DSA, PGP private keys |
          | â˜ï¸ Cloud | GCP, Azure, Supabase, MotherDuck |
          | ðŸŽ² Entropy | High-entropy strings (warnings) |
          EOF
