# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                     ðŸ¦† MotherDuck Sync - CI & Publish                        â•‘
# â•‘                                                                              â•‘
# â•‘  Pipeline Flow:                                                              â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â•‘
# â•‘  â”‚ Gate    â”‚â”€â”€â–¶â”‚ Quality (parallel)                           â”‚              â•‘
# â•‘  â”‚ â€¢ stale â”‚   â”‚ â€¢ format â€¢ lint â€¢ build â€¢ test â€¢ docs        â”‚              â•‘
# â•‘  â”‚ â€¢ secretsâ”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚                                          â•‘
# â•‘                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â•‘
# â•‘                    â–¼                             â–¼                           â•‘
# â•‘              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â•‘
# â•‘              â”‚ Security â”‚                 â”‚ Package  â”‚                       â•‘
# â•‘              â”‚ â€¢ audit  â”‚                 â”‚ â€¢ verify â”‚                       â•‘
# â•‘              â”‚ â€¢ scan   â”‚                 â”‚ â€¢ dry-runâ”‚                       â•‘
# â•‘              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â•‘
# â•‘                    â”‚                             â”‚                           â•‘
# â•‘                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â•‘
# â•‘                                   â–¼                                          â•‘
# â•‘                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â•‘
# â•‘                            â”‚  Publish   â”‚ (main branch only)                 â•‘
# â•‘                            â”‚  crates.io â”‚                                    â•‘
# â•‘                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CI & Publish

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-A missing_docs"
  RUST_BACKTRACE: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: Gate - Fast checks before expensive operations
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gate:
    name: ðŸš¦ Gate
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    steps:
      - name: ðŸ›‘ Cancel stale runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
          all_but_latest: true

      - name: ðŸ”‘ Validate secrets
        id: check
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ðŸ”‘ Secrets Configuration               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          check_secret() {
            local name=$1
            local value=$2
            local required=$3
            if [ -n "$value" ]; then
              echo "  âœ… $name"
              return 0
            else
              if [ "$required" = "true" ]; then
                echo "  âŒ $name (required)"
                return 1
              else
                echo "  âš ï¸  $name (optional)"
                return 0
              fi
            fi
          }
          
          echo ""
          FAILED=0
          
          # CI secrets (required)
          check_secret "CARGO_REGISTRY_TOKEN" "${{ secrets.CARGO_REGISTRY_TOKEN }}" "true" || FAILED=1
          
          # Sync secrets (optional for CI)
          check_secret "MOTHERDUCK_TOKEN" "${{ secrets.MOTHERDUCK_TOKEN }}" "false"
          check_secret "DATABASE_URL" "${{ secrets.DATABASE_URL }}" "false"
          check_secret "SYNC_TABLES_CONFIG" "${{ secrets.SYNC_TABLES_CONFIG }}" "false"
          
          echo ""
          if [ $FAILED -eq 1 ]; then
            echo "ðŸ“ Configure at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          # Set output for publish decision
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: Quality - Parallel code quality checks
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  format:
    name: ðŸŽ¨ Format
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --check

  lint:
    name: ðŸ“Ž Lint
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-targets -- -D warnings

  build:
    name: ðŸ”¨ Build
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo build --release
      - uses: actions/upload-artifact@v4
        with:
          name: binary-${{ github.sha }}
          path: target/release/motherduck-sync
          retention-days: 7

  test:
    name: âœ… Test
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --all-features --no-fail-fast

  docs:
    name: ðŸ“š Docs
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo doc --no-deps
        env:
          RUSTDOCFLAGS: "-A missing_docs -D warnings"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: Security - After quality passes
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security:
    name: ðŸ” Security
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ” Audit dependencies
        run: |
          cargo install cargo-audit --locked 2>/dev/null || true
          echo "â•â•â• Dependency Audit â•â•â•"
          cargo audit 2>&1 || echo "âš ï¸ Review vulnerabilities above"
      
      - name: ðŸ•µï¸ Scan for hardcoded secrets
        run: |
          echo "â•â•â• Secrets Scan â•â•â•"
          EXCLUDE="your_|example|test|placeholder|localhost|127\.0\.0\.1|//!"
          FOUND=0
          
          # AWS keys
          grep -rE "AKIA[0-9A-Z]{16}" --include="*.rs" src/ 2>/dev/null && FOUND=1
          
          # Real database URLs (not localhost)
          grep -rE "postgres://\w+:\w+@[\w.-]+\.(com|io|net):" --include="*.rs" src/ 2>/dev/null | grep -vE "$EXCLUDE" && FOUND=1
          
          # JWT tokens
          grep -rE "eyJ[a-zA-Z0-9_-]{20,}\.eyJ" --include="*.rs" src/ 2>/dev/null | grep -vE "$EXCLUDE" && FOUND=1
          
          [ $FOUND -eq 0 ] && echo "âœ… No secrets detected" || { echo "âŒ Secrets found"; exit 1; }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: Package - After quality passes (parallel with security)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  package:
    name: ðŸ“¦ Package
    needs: [format, lint, build, test]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Verify package
        run: |
          echo "â•â•â• Package Contents â•â•â•"
          cargo package --list
          echo ""
          echo "â•â•â• Dry-run Publish â•â•â•"
          cargo publish --dry-run

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: Publish - Only on main branch after all checks pass
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish:
    name: ðŸš€ Publish
    needs: [gate, security, package, docs]
    if: needs.gate.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: crates-io
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: ðŸ“¤ Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ðŸš€ Publishing to crates.io               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          OUTPUT=$(cargo publish 2>&1) || true
          echo "$OUTPUT"
          
          if echo "$OUTPUT" | grep -q "already uploaded"; then
            echo "âœ… Version already published"
          elif echo "$OUTPUT" | grep -q "Uploading"; then
            echo "âœ… Published: https://crates.io/crates/motherduck-sync"
          else
            echo "âŒ Publish failed"
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: Summary - Always runs
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ðŸ“Š Summary
    needs: [gate, format, lint, build, test, docs, security, package]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ¦† MotherDuck Sync CI
          
          | Stage | Job | Status |
          |-------|-----|--------|
          | Gate | ðŸš¦ Gate | ${{ needs.gate.result == 'success' && 'âœ…' || 'âŒ' }} |
          | Quality | ðŸŽ¨ Format | ${{ needs.format.result == 'success' && 'âœ…' || needs.format.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Quality | ðŸ“Ž Lint | ${{ needs.lint.result == 'success' && 'âœ…' || needs.lint.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Quality | ðŸ”¨ Build | ${{ needs.build.result == 'success' && 'âœ…' || needs.build.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Quality | âœ… Test | ${{ needs.test.result == 'success' && 'âœ…' || needs.test.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Quality | ðŸ“š Docs | ${{ needs.docs.result == 'success' && 'âœ…' || needs.docs.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | Security | ðŸ” Security | ${{ needs.security.result == 'success' && 'âœ…' || needs.security.result == 'skipped' && 'â­ï¸' || 'âš ï¸' }} |
          | Package | ðŸ“¦ Package | ${{ needs.package.result == 'success' && 'âœ…' || needs.package.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          EOF
