# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                     ğŸ¦† MotherDuck Sync - CI/CD Pipeline                      â•‘
# â•‘                                                                              â•‘
# â•‘  Pipeline Flow:                                                              â•‘
# â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â•‘
# â•‘  â”‚ Gate    â”‚â”€â”€â–¶â”‚ Quality (single job, sequential)             â”‚              â•‘
# â•‘  â”‚ â€¢ stale â”‚   â”‚ format â†’ lint â†’ build â†’ test â†’ docs          â”‚              â•‘
# â•‘  â”‚ â€¢ secretsâ”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â•‘
# â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚                                          â•‘
# â•‘                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â•‘
# â•‘                    â–¼                             â–¼                           â•‘
# â•‘              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â•‘
# â•‘              â”‚ Security â”‚                 â”‚ Package  â”‚                       â•‘
# â•‘              â”‚ â€¢ audit  â”‚                 â”‚ â€¢ verify â”‚                       â•‘
# â•‘              â”‚ â€¢ 7 scansâ”‚                 â”‚ â€¢ dry-runâ”‚                       â•‘
# â•‘              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â•‘
# â•‘                    â”‚                             â”‚                           â•‘
# â•‘                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â•‘
# â•‘                                   â–¼                                          â•‘
# â•‘                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â•‘
# â•‘                            â”‚  Release   â”‚ (main + src/ changes)              â•‘
# â•‘                            â”‚ â€¢ bump ver â”‚                                    â•‘
# â•‘                            â”‚ â€¢ git tag  â”‚                                    â•‘
# â•‘                            â”‚ â€¢ GH releaseâ”‚                                   â•‘
# â•‘                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â•‘
# â•‘                                   â”‚                                          â•‘
# â•‘                                   â–¼                                          â•‘
# â•‘                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â•‘
# â•‘                            â”‚  Publish   â”‚                                    â•‘
# â•‘                            â”‚  crates.io â”‚                                    â•‘
# â•‘                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      bump:
        description: 'Force version bump type'
        required: false
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-A missing_docs"
  RUST_BACKTRACE: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: Gate - Fast checks before expensive operations
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  gate:
    name: ğŸš¦ Gate
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      is_main: ${{ steps.check.outputs.is_main }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ›‘ Cancel stale runs
        uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
          all_but_latest: true

      - name: ğŸ”‘ Validate secrets & check release
        id: check
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸ”‘ Secrets Configuration               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          FAILED=0
          [ -n "${{ secrets.CARGO_REGISTRY_TOKEN }}" ] && echo "  âœ… CARGO_REGISTRY_TOKEN" || { echo "  âŒ CARGO_REGISTRY_TOKEN (required)"; FAILED=1; }
          [ -n "${{ secrets.MOTHERDUCK_TOKEN }}" ] && echo "  âœ… MOTHERDUCK_TOKEN" || echo "  âš ï¸  MOTHERDUCK_TOKEN (optional)"
          
          if [ $FAILED -eq 1 ]; then
            echo "ğŸ“ Configure at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi
          
          # Check if this is main branch
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "is_main=true" >> $GITHUB_OUTPUT
            
            # Check if src/ or Cargo.toml changed (library modification)
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -E "^(src/|Cargo\.toml)" || true)
            if [ -n "$CHANGED" ] || [ "${{ github.event.inputs.bump }}" != "" ]; then
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "ğŸ“¦ Library modified - will create release"
            else
              echo "should_release=false" >> $GITHUB_OUTPUT
              echo "â­ï¸ No library changes - skipping release"
            fi
          else
            echo "is_main=false" >> $GITHUB_OUTPUT
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: Quality - Single job, compile once, run all checks
  # Uses pre-built DuckDB library for fast builds (~3min vs ~15min)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  quality:
    name: ğŸ” Quality
    needs: gate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      DUCKDB_VERSION: "1.1.3"
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ¦† Install DuckDB library
        run: |
          # Download pre-built DuckDB
          wget -q "https://github.com/duckdb/duckdb/releases/download/v${DUCKDB_VERSION}/libduckdb-linux-amd64.zip"
          unzip -q libduckdb-linux-amd64.zip -d duckdb-lib
          
          # Install to system paths
          sudo cp duckdb-lib/libduckdb.so /usr/local/lib/
          sudo cp duckdb-lib/duckdb.h /usr/local/include/
          sudo ldconfig
          
          # Create pkg-config file
          sudo mkdir -p /usr/local/lib/pkgconfig
          cat << EOF | sudo tee /usr/local/lib/pkgconfig/duckdb.pc
          prefix=/usr/local
          libdir=\${prefix}/lib
          includedir=\${prefix}/include
          
          Name: DuckDB
          Description: DuckDB embedded database
          Version: ${DUCKDB_VERSION}
          Libs: -L\${libdir} -lduckdb
          Cflags: -I\${includedir}
          EOF
          
          echo "âœ… DuckDB ${DUCKDB_VERSION} installed"
      
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      
      - name: ğŸ¨ Format check
        run: cargo fmt --check
      
      - name: ğŸ“ Lint (clippy)
        run: cargo clippy --no-default-features --features cli,tls-native --all-targets -- -W clippy::all -A dead_code -A unused_variables -A missing_docs -A clippy::redundant_closure
      
      - name: ğŸ”¨ Build release
        run: cargo build --no-default-features --features cli,tls-native --release
      
      - name: âœ… Run tests
        run: cargo test --no-default-features --features cli,tls-native --no-fail-fast
      
      - name: ğŸ“š Build docs
        run: cargo doc --no-default-features --features cli,tls-native --no-deps
        env:
          RUSTDOCFLAGS: "-D warnings -A missing_docs"
      
      - name: ğŸ“¤ Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ github.sha }}
          path: target/release/motherduck-sync
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: Security - Parallel scans (no compilation needed)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security:
    name: ğŸ” Security
    needs: quality
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ” Audit dependencies
        run: |
          cargo install cargo-audit --locked 2>/dev/null || true
          cargo audit 2>&1 || echo "âš ï¸ Review vulnerabilities above"
      
      - name: ğŸ”‘ Scan for secrets
        run: |
          echo "â•â•â• Security Scan â•â•â•"
          FOUND=0
          SAFE="localhost|127\.0\.0\.1|example\.com|your_|placeholder|test|//!|///|#|\.example"
          
          # AWS keys
          grep -rE "AKIA[0-9A-Z]{16}" --include="*.rs" --include="*.toml" . 2>/dev/null && FOUND=1 || true
          
          # Database URLs with real hosts
          grep -rE "postgres(ql)?://[^@]+@[^/]+\.(com|io|net|org|cloud|supabase)" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" && FOUND=1 || true
          
          # JWT tokens
          grep -rE "eyJ[a-zA-Z0-9_-]{20,}\.eyJ[a-zA-Z0-9_-]{20,}\.[a-zA-Z0-9_-]{20,}" --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" && FOUND=1 || true
          
          # GitHub tokens
          grep -rE "(ghp|gho|ghu|ghs|ghr)_[A-Za-z0-9_]{36,}" --include="*.rs" --include="*.toml" . 2>/dev/null && FOUND=1 || true
          
          # Private keys
          grep -rE "-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----" --include="*.rs" --include="*.toml" --include="*.pem" . 2>/dev/null && FOUND=1 || true
          
          # MotherDuck tokens
          grep -rE 'md_[a-zA-Z0-9_-]{30,}' --include="*.rs" --include="*.toml" . 2>/dev/null | grep -vE "$SAFE" && FOUND=1 || true
          
          [ $FOUND -eq 0 ] && echo "âœ… No secrets found" || { echo "âŒ Secrets detected!"; exit 1; }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: Package - Verify publishable (uses bundled for crates.io)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  package:
    name: ğŸ“¦ Package
    needs: quality
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Verify package
        run: |
          cargo package --list
          cargo publish --dry-run

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: Release - Bump version, tag, GitHub release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    name: ğŸ·ï¸ Release
    needs: [gate, security, package]
    if: needs.gate.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    outputs:
      version: ${{ steps.bump.outputs.version }}
      released: ${{ steps.bump.outputs.released }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“ˆ Bump version & release
        id: bump
        run: |
          # Get current version
          CURRENT=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT"
          
          # Determine bump type
          if [ "${{ github.event.inputs.bump }}" != "" ] && [ "${{ github.event.inputs.bump }}" != "auto" ]; then
            BUMP="${{ github.event.inputs.bump }}"
          else
            # Auto-detect from commits
            COMMITS=$(git log --oneline $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")..HEAD 2>/dev/null || git log --oneline -10)
            if echo "$COMMITS" | grep -qiE "BREAKING CHANGE|^[a-f0-9]+ feat.*!:"; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qiE "^[a-f0-9]+ feat"; then
              BUMP="minor"
            else
              BUMP="patch"
            fi
          fi
          echo "Bump type: $BUMP"
          
          # Calculate new version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          case $BUMP in
            major) NEW="$((MAJOR + 1)).0.0" ;;
            minor) NEW="$MAJOR.$((MINOR + 1)).0" ;;
            patch) NEW="$MAJOR.$MINOR.$((PATCH + 1))" ;;
          esac
          echo "New version: $NEW"
          
          # Check if tag exists
          if git rev-parse "v$NEW" >/dev/null 2>&1; then
            echo "â­ï¸ Tag v$NEW already exists"
            echo "version=$CURRENT" >> $GITHUB_OUTPUT
            echo "released=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Update Cargo.toml
          sed -i "s/^version = \".*\"/version = \"$NEW\"/" Cargo.toml
          cargo update --workspace
          
          # Commit, tag, push
          git add Cargo.toml Cargo.lock
          git commit -m "chore(release): v$NEW"
          git tag -a "v$NEW" -m "Release v$NEW"
          git push origin main --tags
          
          echo "version=$NEW" >> $GITHUB_OUTPUT
          echo "released=true" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create GitHub Release
        if: steps.bump.outputs.released == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump.outputs.version }}
          name: v${{ steps.bump.outputs.version }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: Publish - Push to crates.io
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  publish:
    name: ğŸš€ Publish
    needs: [gate, release]
    if: needs.gate.outputs.is_main == 'true' && (needs.release.outputs.released == 'true' || needs.release.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main  # Get latest with version bump
      - uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¤ Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸš€ Publishing to crates.io               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Pull latest (includes version bump)
          git pull origin main || true
          
          OUTPUT=$(cargo publish 2>&1) || true
          echo "$OUTPUT"
          
          if echo "$OUTPUT" | grep -q "already uploaded"; then
            echo "âœ… Version already published"
          elif echo "$OUTPUT" | grep -q "Uploading"; then
            echo "âœ… Published: https://crates.io/crates/motherduck-sync"
          else
            echo "âŒ Publish failed"
            exit 1
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Summary
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: ğŸ“Š Summary
    needs: [gate, quality, security, package, release, publish]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸ¦† MotherDuck Sync CI/CD
          
          | Stage | Status |
          |-------|--------|
          | ğŸš¦ Gate | ${{ needs.gate.result == 'success' && 'âœ…' || 'âŒ' }} |
          | ğŸ” Quality | ${{ needs.quality.result == 'success' && 'âœ…' || needs.quality.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | ğŸ” Security | ${{ needs.security.result == 'success' && 'âœ…' || needs.security.result == 'skipped' && 'â­ï¸' || 'âš ï¸' }} |
          | ğŸ“¦ Package | ${{ needs.package.result == 'success' && 'âœ…' || needs.package.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | ğŸ·ï¸ Release | ${{ needs.release.result == 'success' && 'âœ…' || needs.release.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          | ğŸš€ Publish | ${{ needs.publish.result == 'success' && 'âœ…' || needs.publish.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
          EOF
