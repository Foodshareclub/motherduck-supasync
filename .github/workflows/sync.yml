# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                        ü¶Ü MotherDuck Analytics Sync                          ‚ïë
# ‚ïë                                                                              ‚ïë
# ‚ïë  Syncs analytics data from Supabase PostgreSQL to MotherDuck warehouse       ‚ïë
# ‚ïë  Schedule: 3x daily (morning, midday, evening UTC)                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

name: ü¶Ü MotherDuck Sync

on:
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 11 * * *'
    - cron: '0 19 * * *'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/sync.yml'
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Full sync (resync all records)'
        type: boolean
        default: false

concurrency:
  group: motherduck-sync-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  preflight:
    name: üîê Preflight
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      secrets_valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: Validate secrets
        id: check
        run: |
          MISSING=""
          [ -z "${{ secrets.DATABASE_URL }}" ] && MISSING="${MISSING}DATABASE_URL "
          [ -z "${{ secrets.MOTHERDUCK_TOKEN }}" ] && MISSING="${MISSING}MOTHERDUCK_TOKEN "
          [ -z "${{ secrets.SYNC_TABLES_CONFIG }}" ] && MISSING="${MISSING}SYNC_TABLES_CONFIG "
          if [ -n "$MISSING" ]; then
            echo "::error::Missing: $MISSING"
            exit 1
          fi
          echo "valid=true" >> $GITHUB_OUTPUT

  build:
    name: üî® Build
    needs: [preflight]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      - run: cargo build --release
      - uses: actions/upload-artifact@v4
        with:
          name: motherduck-sync-${{ github.sha }}
          path: target/release/motherduck-sync
          retention-days: 7

  sync:
    name: üöÄ Sync
    needs: [preflight, build]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
      SYNC_TABLES_CONFIG: ${{ secrets.SYNC_TABLES_CONFIG }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: motherduck-sync-${{ github.sha }}
      - run: chmod +x motherduck-sync
      - name: Test connectivity
        run: |
          # Redact connection URLs from output
          ./motherduck-sync test 2>&1 | sed 's/[a-z0-9-]*\.pooler\.supabase\.com/[db-host]/g; s/:[0-9]*\/[a-z]*/:***\/[db]/g' || exit 1
          echo "‚úì Connectivity OK"
      - name: Refresh staging
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client -qq >/dev/null 2>&1
          psql "$DATABASE_URL" -c "CALL refresh_analytics_staging();" 2>&1 | grep -v "^$" | head -5
      - name: Sync
        run: |
          ARGS="sync"
          [ "${{ inputs.full_sync }}" = "true" ] && ARGS="$ARGS --full"
          # Run sync, capture exit code, redact output
          set +e
          ./motherduck-sync $ARGS --json > sync-result-raw.json 2>&1
          SYNC_EXIT=$?
          set -e
          # Redact table names from output (replace with table_1, table_2, etc)
          python3 << 'EOF'
          import json, sys
          try:
              with open('sync-result-raw.json') as f:
                  data = json.load(f)
              # Redact table names
              if 'tables' in data:
                  redacted = {}
                  for i, (k, v) in enumerate(data['tables'].items(), 1):
                      key = f"table_{i}"
                      v['source_table'] = f"source_{i}"
                      v['target_table'] = f"target_{i}"
                      if v.get('error'):
                          v['error'] = v['error'].split(':')[0] + ': [redacted]' if ':' in v['error'] else '[redacted]'
                      redacted[key] = v
                  data['tables'] = redacted
              with open('sync-result.json', 'w') as f:
                  json.dump(data, f, indent=2)
              # Print summary only
              total = sum(t.get('records_synced', 0) for t in data.get('tables', {}).values())
              failed = len([t for t in data.get('tables', {}).values() if not t.get('success', True)])
              print(f"‚úì Synced {total} records across {len(data.get('tables', {}))} tables ({failed} failed)")
          except Exception as e:
              print(f"‚ö† Could not parse sync result: {e}")
              with open('sync-result-raw.json') as f:
                  print("[raw output redacted]")
              with open('sync-result.json', 'w') as f:
                  f.write('{"redacted": true}')
          EOF
          exit $SYNC_EXIT
      - name: Verify
        run: |
          # Suppress table names in verify output
          ./motherduck-sync query --counts 2>&1 | sed 's/[a-z_]*staging[a-z_]*/[table]/g; s/full_[a-z_]*/[table]/g' || true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sync-result-${{ github.run_id }}
          path: sync-result.json
          retention-days: 30
      - name: Summary
        if: always()
        run: |
          echo "## ü¶Ü Sync Complete" >> $GITHUB_STEP_SUMMARY
          if [ -f sync-result.json ]; then
            # Show redacted summary
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          try:
              with open('sync-result.json') as f:
                  data = json.load(f)
              total = sum(t.get('records_synced', 0) for t in data.get('tables', {}).values())
              success = data.get('success', False)
              tables = len(data.get('tables', {}))
              failed = len([t for t in data.get('tables', {}).values() if not t.get('success', True)])
              print(f"| Metric | Value |")
              print(f"|--------|-------|")
              print(f"| Status | {'‚úÖ Success' if success else '‚ö†Ô∏è Partial'} |")
              print(f"| Tables | {tables} |")
              print(f"| Records | {total:,} |")
              print(f"| Failed | {failed} |")
          except:
              print("_Results redacted_")
          EOF
          fi
