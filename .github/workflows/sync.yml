# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                        ü¶Ü MotherDuck Analytics Sync                          ‚ïë
# ‚ïë                                                                              ‚ïë
# ‚ïë  Syncs analytics data from Supabase PostgreSQL to MotherDuck warehouse       ‚ïë
# ‚ïë  Schedule: 3x daily (morning, midday, evening UTC)                           ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

name: ü¶Ü MotherDuck Sync

on:
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 11 * * *'
    - cron: '0 19 * * *'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/sync.yml'
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Full sync (resync all records)'
        type: boolean
        default: false

concurrency:
  group: motherduck-sync-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  preflight:
    name: üîê Preflight
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      secrets_valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: Validate secrets
        id: check
        run: |
          MISSING=""
          [ -z "${{ secrets.DATABASE_URL }}" ] && MISSING="${MISSING}DATABASE_URL "
          [ -z "${{ secrets.MOTHERDUCK_TOKEN }}" ] && MISSING="${MISSING}MOTHERDUCK_TOKEN "
          [ -z "${{ secrets.SYNC_TABLES_CONFIG }}" ] && MISSING="${MISSING}SYNC_TABLES_CONFIG "
          if [ -n "$MISSING" ]; then
            echo "::error::Missing: $MISSING"
            exit 1
          fi
          echo "valid=true" >> $GITHUB_OUTPUT

  build:
    name: üî® Build
    needs: [preflight]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      DUCKDB_VERSION: "1.1.3"
    steps:
      - uses: actions/checkout@v4
      
      - name: ü¶Ü Install DuckDB library
        run: |
          wget -q "https://github.com/duckdb/duckdb/releases/download/v${DUCKDB_VERSION}/libduckdb-linux-amd64.zip"
          unzip -q libduckdb-linux-amd64.zip -d duckdb-lib
          sudo cp duckdb-lib/libduckdb.so /usr/local/lib/
          sudo cp duckdb-lib/duckdb.h /usr/local/include/
          sudo ldconfig
          sudo mkdir -p /usr/local/lib/pkgconfig
          cat << EOF | sudo tee /usr/local/lib/pkgconfig/duckdb.pc
          prefix=/usr/local
          libdir=\${prefix}/lib
          includedir=\${prefix}/include
          Name: DuckDB
          Version: ${DUCKDB_VERSION}
          Libs: -L\${libdir} -lduckdb
          Cflags: -I\${includedir}
          EOF
      
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      
      - name: Build
        run: cargo build --no-default-features --features cli,tls-native --release
        env:
          LIBRARY_PATH: /usr/local/lib
          LD_LIBRARY_PATH: /usr/local/lib
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
      
      - uses: actions/upload-artifact@v4
        with:
          name: motherduck-sync-${{ github.sha }}
          path: target/release/motherduck-sync
          retention-days: 7

  sync:
    name: üöÄ Sync
    needs: [preflight, build]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
      SYNC_TABLES_CONFIG: ${{ secrets.SYNC_TABLES_CONFIG }}
      DUCKDB_VERSION: "1.1.3"
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: motherduck-sync-${{ github.sha }}
      
      - name: ü¶Ü Install DuckDB library
        run: |
          # The binary is dynamically linked - need libduckdb.so at runtime
          wget -q "https://github.com/duckdb/duckdb/releases/download/v${DUCKDB_VERSION}/libduckdb-linux-amd64.zip"
          unzip -q libduckdb-linux-amd64.zip -d duckdb-lib
          sudo cp duckdb-lib/libduckdb.so /usr/local/lib/
          sudo ldconfig
          echo "‚úÖ DuckDB ${DUCKDB_VERSION} runtime installed"
      
      - run: chmod +x motherduck-sync
      
      - name: Test connectivity
        run: |
          # Check if config is valid
          if [ -z "$SYNC_TABLES_CONFIG" ]; then
            echo "::error::SYNC_TABLES_CONFIG is empty"
            exit 1
          fi
          
          # Decode and validate config (expects JSON array, not {"tables": [...]})
          echo "$SYNC_TABLES_CONFIG" | base64 -d > /tmp/tables.json 2>/dev/null || {
            echo "::error::SYNC_TABLES_CONFIG is not valid base64"
            exit 1
          }
          
          # Parse as array directly (format: [{...}, {...}])
          TABLE_COUNT=$(python3 -c "
          import json
          with open('/tmp/tables.json') as f:
              data = json.load(f)
          # Handle both array format and object format
          if isinstance(data, list):
              print(len(data))
          elif isinstance(data, dict) and 'tables' in data:
              print(len(data['tables']))
          else:
              print(0)
          " 2>/dev/null || echo "0")
          
          if [ "$TABLE_COUNT" = "0" ]; then
            echo "::error::SYNC_TABLES_CONFIG has no tables configured"
            exit 1
          fi
          echo "‚úì Config valid: $TABLE_COUNT tables"
          
          # Redact connection URLs from output
          ./motherduck-sync test 2>&1 | sed 's/[a-z0-9-]*\.pooler\.supabase\.com/[db-host]/g; s/:[0-9]*\/[a-z]*/:***\/[db]/g' || exit 1
          echo "‚úì Connectivity OK"
      - name: Refresh staging
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client -qq >/dev/null 2>&1
          psql "$DATABASE_URL" -c "CALL refresh_analytics_staging();" 2>&1 | grep -v "^$" | head -5
      - name: Sync
        run: |
          ARGS="sync"
          [ "${{ inputs.full_sync }}" = "true" ] && ARGS="$ARGS --full"
          # Run sync, capture exit code, separate logs from JSON
          set +e
          ./motherduck-sync $ARGS --json 2>sync-logs.txt | tail -1 > sync-result-raw.json
          SYNC_EXIT=$?
          set -e
          # Redact table names from output (replace with table_1, table_2, etc)
          python3 << 'EOF'
          import json, sys
          try:
              with open('sync-result-raw.json') as f:
                  content = f.read().strip()
                  # Find JSON object in output
                  start = content.find('{')
                  if start >= 0:
                      content = content[start:]
                  data = json.loads(content)
              # Redact table names
              if 'tables' in data:
                  redacted = {}
                  for i, (k, v) in enumerate(data['tables'].items(), 1):
                      key = f"table_{i}"
                      v['source_table'] = f"source_{i}"
                      v['target_table'] = f"target_{i}"
                      if v.get('error'):
                          v['error'] = '[redacted]'
                      redacted[key] = v
                  data['tables'] = redacted
              if 'error' in data:
                  data['error'] = '[redacted]'
              with open('sync-result.json', 'w') as f:
                  json.dump(data, f, indent=2)
              # Print summary only
              total = sum(t.get('records_synced', 0) for t in data.get('tables', {}).values())
              failed = len([t for t in data.get('tables', {}).values() if not t.get('success', True)])
              print(f"‚úì Synced {total} records across {len(data.get('tables', {}))} tables ({failed} failed)")
          except Exception as e:
              print(f"‚ö† Sync output processing: {type(e).__name__}")
              with open('sync-result.json', 'w') as f:
                  f.write('{"redacted": true}')
          EOF
          exit $SYNC_EXIT
      - name: Verify
        run: |
          # Suppress all table names in verify output
          ./motherduck-sync query --counts 2>&1 | sed 's/[a-z_]*staging[a-z_]*/[table]/g; s/full_[a-z_]*/[table]/g; s/[a-z_]*_stats/[table]/g; s/[a-z_]*_summary/[table]/g; s/[a-z_]*_activity[a-z_]*/[table]/g' | grep -E "(Total|records)" || echo "‚úì Verify complete"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sync-result-${{ github.run_id }}
          path: sync-result.json
          retention-days: 30
      - name: Summary
        if: always()
        run: |
          echo "## ü¶Ü Sync Complete" >> $GITHUB_STEP_SUMMARY
          if [ -f sync-result.json ]; then
            # Show redacted summary
            python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          try:
              with open('sync-result.json') as f:
                  data = json.load(f)
              total = sum(t.get('records_synced', 0) for t in data.get('tables', {}).values())
              success = data.get('success', False)
              tables = len(data.get('tables', {}))
              failed = len([t for t in data.get('tables', {}).values() if not t.get('success', True)])
              print(f"| Metric | Value |")
              print(f"|--------|-------|")
              print(f"| Status | {'‚úÖ Success' if success else '‚ö†Ô∏è Partial'} |")
              print(f"| Tables | {tables} |")
              print(f"| Records | {total:,} |")
              print(f"| Failed | {failed} |")
          except:
              print("_Results redacted_")
          EOF
          fi
