# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                        ðŸ¦† MotherDuck Analytics Sync                          â•‘
# â•‘                                                                              â•‘
# â•‘  Syncs analytics data from Supabase PostgreSQL to MotherDuck warehouse       â•‘
# â•‘  Schedule: 3x daily (morning, midday, evening UTC)                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ðŸ¦† MotherDuck Sync

on:
  schedule:
    - cron: '0 3 * * *'
    - cron: '0 11 * * *'
    - cron: '0 19 * * *'
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/sync.yml'
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Full sync (resync all records)'
        type: boolean
        default: false

concurrency:
  group: motherduck-sync-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  preflight:
    name: ðŸ” Preflight
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      secrets_valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: Validate secrets
        id: check
        run: |
          MISSING=""
          [ -z "${{ secrets.DATABASE_URL }}" ] && MISSING="${MISSING}DATABASE_URL "
          [ -z "${{ secrets.MOTHERDUCK_TOKEN }}" ] && MISSING="${MISSING}MOTHERDUCK_TOKEN "
          [ -z "${{ secrets.SYNC_TABLES_CONFIG }}" ] && MISSING="${MISSING}SYNC_TABLES_CONFIG "
          if [ -n "$MISSING" ]; then
            echo "::error::Missing: $MISSING"
            exit 1
          fi
          echo "valid=true" >> $GITHUB_OUTPUT

  build:
    name: ðŸ”¨ Build
    needs: [preflight]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      DUCKDB_VERSION: "1.1.3"
    steps:
      - uses: actions/checkout@v4
      
      - name: ðŸ¦† Install DuckDB library
        run: |
          wget -q "https://github.com/duckdb/duckdb/releases/download/v${DUCKDB_VERSION}/libduckdb-linux-amd64.zip"
          unzip -q libduckdb-linux-amd64.zip -d duckdb-lib
          sudo cp duckdb-lib/libduckdb.so /usr/local/lib/
          sudo cp duckdb-lib/duckdb.h /usr/local/include/
          sudo ldconfig
          sudo mkdir -p /usr/local/lib/pkgconfig
          cat << EOF | sudo tee /usr/local/lib/pkgconfig/duckdb.pc
          prefix=/usr/local
          libdir=\${prefix}/lib
          includedir=\${prefix}/include
          Name: DuckDB
          Version: ${DUCKDB_VERSION}
          Libs: -L\${libdir} -lduckdb
          Cflags: -I\${includedir}
          EOF
      
      - uses: dtolnay/rust-toolchain@nightly
      - uses: Swatinem/rust-cache@v2
      
      - name: Build
        run: cargo build --no-default-features --features cli,tls-native --release
        env:
          LIBRARY_PATH: /usr/local/lib
          LD_LIBRARY_PATH: /usr/local/lib
          PKG_CONFIG_PATH: /usr/local/lib/pkgconfig
      
      - uses: actions/upload-artifact@v4
        with:
          name: motherduck-sync-${{ github.sha }}
          path: target/release/motherduck-sync
          retention-days: 7

  sync:
    name: ðŸš€ Sync
    needs: [preflight, build]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}
      SYNC_TABLES_CONFIG: ${{ secrets.SYNC_TABLES_CONFIG }}
      DUCKDB_VERSION: "1.1.3"
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: motherduck-sync-${{ github.sha }}
      
      - name: ðŸ¦† Install DuckDB library
        run: |
          wget -q "https://github.com/duckdb/duckdb/releases/download/v${DUCKDB_VERSION}/libduckdb-linux-amd64.zip"
          unzip -q libduckdb-linux-amd64.zip -d duckdb-lib
          sudo cp duckdb-lib/libduckdb.so /usr/local/lib/
          sudo ldconfig
          echo "âœ… DuckDB ${DUCKDB_VERSION} runtime installed"
      
      - run: chmod +x motherduck-sync
      
      - name: Validate config
        run: |
          # Validate config exists
          if [ -z "$SYNC_TABLES_CONFIG" ]; then
            echo "::error::SYNC_TABLES_CONFIG is empty"
            exit 1
          fi
          
          # Decode and show format (first 100 chars, redacted)
          DECODED=$(echo "$SYNC_TABLES_CONFIG" | base64 -d 2>/dev/null || echo "DECODE_FAILED")
          if [ "$DECODED" = "DECODE_FAILED" ]; then
            echo "::error::SYNC_TABLES_CONFIG is not valid base64"
            exit 1
          fi
          
          # Show format type
          FIRST_CHAR=$(echo "$DECODED" | head -c1)
          if [ "$FIRST_CHAR" = "[" ]; then
            echo "âœ“ Config format: JSON array"
          elif [ "$FIRST_CHAR" = "{" ]; then
            echo "âœ“ Config format: JSON object"
            # Check if it has "tables" key
            if echo "$DECODED" | grep -q '"tables"'; then
              echo "  â†’ Has 'tables' key (object format)"
            fi
          else
            echo "::error::Unknown config format (starts with: $FIRST_CHAR)"
            exit 1
          fi
          
          # Count tables using jq-like parsing with sed
          TABLE_COUNT=$(echo "$DECODED" | grep -o '"source"' | wc -l | tr -d ' ')
          echo "âœ“ Tables configured: $TABLE_COUNT"
          
          if [ "$TABLE_COUNT" = "0" ]; then
            echo "::error::No tables found in config"
            exit 1
          fi

      - name: Test connectivity
        run: |
          # Use Rust CLI to test connectivity (redact output)
          LOG_LEVEL=debug ./motherduck-sync test 2>&1 | sed 's/[a-z0-9-]*\.pooler\.supabase\.com/[db-host]/g; s/:[0-9]*\/[a-z]*/:***\/[db]/g; s/postgres:\/\/[^@]*@/postgres:\/\/***@/g; s/[a-z_]*staging[a-z_]*/[table]/g' | head -20 || exit 1
          echo "âœ“ Connectivity OK"

      - name: Refresh staging
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client -qq >/dev/null 2>&1
          psql "$DATABASE_URL" -c "CALL refresh_analytics_staging();" 2>&1 | grep -v "^$" | head -5

      - name: Sync
        run: |
          ARGS="sync"
          [ "${{ inputs.full_sync }}" = "true" ] && ARGS="$ARGS --full"
          
          # Run sync with JSON output, capture separately
          set +e
          ./motherduck-sync $ARGS --json > sync-stdout.txt 2> sync-stderr.txt
          SYNC_EXIT=$?
          set -e
          
          # Show redacted stderr
          echo "=== Logs (redacted): ==="
          head -10 sync-stderr.txt | sed 's/[a-z0-9-]*\.pooler\.supabase\.com/[host]/g; s/postgres:\/\/[^@]*@/postgres:\/\/***@/g; s/[a-z_]*staging[a-z_]*/[table]/g' || true
          
          # Process JSON output with sed (no Python)
          if [ -s sync-stdout.txt ]; then
            # Redact table names in JSON
            sed 's/"source_table": "[^"]*"/"source_table": "[redacted]"/g; s/"target_table": "[^"]*"/"target_table": "[redacted]"/g; s/"error": "[^"]*"/"error": "[redacted]"/g' sync-stdout.txt > sync-result.json
            
            # Extract summary using grep/sed
            TABLES=$(grep -o '"tables"' sync-result.json | wc -l || echo "0")
            SUCCESS=$(grep -o '"success": true' sync-result.json | head -1 || echo "")
            echo ""
            if [ -n "$SUCCESS" ]; then
              echo "âœ“ Sync completed successfully"
            else
              echo "âš  Sync completed with issues"
            fi
          else
            echo '{"error": "no output", "success": false}' > sync-result.json
            echo "âš  No output from sync"
          fi
          
          exit $SYNC_EXIT

      - name: Verify
        run: |
          # Use Rust CLI to verify counts (redact table names)
          ./motherduck-sync query --counts 2>&1 | sed 's/[a-z_]*staging[a-z_]*/[table]/g; s/full_[a-z_]*/[table]/g; s/[a-z_]*_stats/[table]/g' | grep -E "(Total|records|â†’)" || echo "âœ“ Verify complete"

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sync-result-${{ github.run_id }}
          path: sync-result.json
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¦† Sync Complete" >> $GITHUB_STEP_SUMMARY
          if [ -f sync-result.json ]; then
            # Extract metrics using grep/sed (no Python)
            SUCCESS=$(grep -o '"success": true' sync-result.json | head -1 && echo "âœ… Success" || echo "âš ï¸ Partial")
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            if grep -q '"success": true' sync-result.json; then
              echo "| Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Status | âš ï¸ Partial |" >> $GITHUB_STEP_SUMMARY
            fi
            # Count tables from JSON structure
            TABLES=$(grep -c '"records_synced"' sync-result.json 2>/dev/null || echo "0")
            echo "| Tables | $TABLES |" >> $GITHUB_STEP_SUMMARY
          fi
