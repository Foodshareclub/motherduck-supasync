# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                     ğŸ¦† MotherDuck Sync - Release                             â•‘
# â•‘                                                                              â•‘
# â•‘  Triggers:                                                                   â•‘
# â•‘  â€¢ Manual dispatch with version bump type (patch/minor/major)                â•‘
# â•‘  â€¢ Automatically on push to main when src/ files change                      â•‘
# â•‘                                                                              â•‘
# â•‘  Actions:                                                                    â•‘
# â•‘  â€¢ Bump version in Cargo.toml                                                â•‘
# â•‘  â€¢ Create git tag                                                            â•‘
# â•‘  â€¢ Create GitHub release with changelog                                      â•‘
# â•‘  â€¢ Trigger CI workflow for publishing to crates.io                           â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'Cargo.toml'

env:
  CARGO_TERM_COLOR: always

jobs:
  check-release:
    name: ğŸ” Check Release
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      current_version: ${{ steps.version.outputs.current }}
      new_version: ${{ steps.version.outputs.new }}
      bump_type: ${{ steps.bump.outputs.type }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”¢ Get current version
        id: version
        run: |
          CURRENT=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Current version: $CURRENT"

      - name: ğŸ¯ Determine bump type
        id: bump
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUMP="${{ github.event.inputs.bump }}"
          else
            # Auto-detect from commit messages
            COMMITS=$(git log --oneline $(git describe --tags --abbrev=0 2>/dev/null || echo "HEAD~10")..HEAD 2>/dev/null || git log --oneline -10)
            
            if echo "$COMMITS" | grep -qiE "^[a-f0-9]+ (feat|feature)(\(.+\))?!:|BREAKING CHANGE"; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qiE "^[a-f0-9]+ (feat|feature)"; then
              BUMP="minor"
            else
              BUMP="patch"
            fi
          fi
          echo "type=$BUMP" >> $GITHUB_OUTPUT
          echo "ğŸ“ˆ Bump type: $BUMP"

      - name: ğŸ§® Calculate new version
        id: calc
        run: |
          CURRENT="${{ steps.version.outputs.current }}"
          BUMP="${{ steps.bump.outputs.type }}"
          
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          case $BUMP in
            major)
              NEW="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW="$MAJOR.$((MINOR + 1)).0"
              ;;
            patch)
              NEW="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
          esac
          
          echo "new=$NEW" >> $GITHUB_OUTPUT
          echo "ğŸ†• New version: $NEW"

      - name: ğŸ·ï¸ Check if tag exists
        id: check
        run: |
          NEW_VERSION="${{ steps.calc.outputs.new }}"
          if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
            echo "â­ï¸ Tag v$NEW_VERSION already exists, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tag v$NEW_VERSION does not exist, proceeding with release"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Set new version output
        run: |
          echo "new=${{ steps.calc.outputs.new }}" >> $GITHUB_OUTPUT
        id: final_version

    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      current_version: ${{ steps.version.outputs.current }}
      new_version: ${{ steps.calc.outputs.new }}
      bump_type: ${{ steps.bump.outputs.type }}

  release:
    name: ğŸš€ Release
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ“ Update Cargo.toml version
        run: |
          NEW_VERSION="${{ needs.check-release.outputs.new_version }}"
          sed -i "s/^version = \".*\"/version = \"$NEW_VERSION\"/" Cargo.toml
          echo "âœ… Updated Cargo.toml to version $NEW_VERSION"

      - name: ğŸ”’ Update Cargo.lock
        run: cargo update --workspace

      - name: ğŸ“‹ Generate changelog
        id: changelog
        run: |
          NEW_VERSION="${{ needs.check-release.outputs.new_version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          echo "## ğŸ¦† MotherDuck Sync v$NEW_VERSION" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          
          if [ -n "$PREV_TAG" ]; then
            echo "### Changes since $PREV_TAG" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            
            # Features
            FEATURES=$(git log $PREV_TAG..HEAD --oneline --grep="^feat" 2>/dev/null || true)
            if [ -n "$FEATURES" ]; then
              echo "#### âœ¨ Features" >> RELEASE_NOTES.md
              echo "$FEATURES" | sed 's/^[a-f0-9]* /- /' >> RELEASE_NOTES.md
              echo "" >> RELEASE_NOTES.md
            fi
            
            # Fixes
            FIXES=$(git log $PREV_TAG..HEAD --oneline --grep="^fix" 2>/dev/null || true)
            if [ -n "$FIXES" ]; then
              echo "#### ğŸ› Bug Fixes" >> RELEASE_NOTES.md
              echo "$FIXES" | sed 's/^[a-f0-9]* /- /' >> RELEASE_NOTES.md
              echo "" >> RELEASE_NOTES.md
            fi
            
            # Other changes
            OTHER=$(git log $PREV_TAG..HEAD --oneline --invert-grep --grep="^feat" --grep="^fix" 2>/dev/null | head -10 || true)
            if [ -n "$OTHER" ]; then
              echo "#### ğŸ“¦ Other Changes" >> RELEASE_NOTES.md
              echo "$OTHER" | sed 's/^[a-f0-9]* /- /' >> RELEASE_NOTES.md
              echo "" >> RELEASE_NOTES.md
            fi
          else
            echo "### ğŸ‰ Initial Release" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "First public release of MotherDuck Sync!" >> RELEASE_NOTES.md
          fi
          
          echo "" >> RELEASE_NOTES.md
          echo "---" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "ğŸ“¦ **Install**: \`cargo install motherduck-sync\`" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "ğŸ“š **Docs**: [crates.io](https://crates.io/crates/motherduck-sync)" >> RELEASE_NOTES.md
          
          cat RELEASE_NOTES.md

      - name: ğŸ’¾ Commit version bump
        run: |
          NEW_VERSION="${{ needs.check-release.outputs.new_version }}"
          git add Cargo.toml Cargo.lock
          git commit -m "chore(release): bump version to $NEW_VERSION"
          git push origin main

      - name: ğŸ·ï¸ Create and push tag
        run: |
          NEW_VERSION="${{ needs.check-release.outputs.new_version }}"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-release.outputs.new_version }}
          name: v${{ needs.check-release.outputs.new_version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Release summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸ‰ Release Complete!                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  ğŸ“¦ Version: ${{ needs.check-release.outputs.new_version }}"
          echo "  ğŸ“ˆ Bump: ${{ needs.check-release.outputs.bump_type }}"
          echo "  ğŸ·ï¸ Tag: v${{ needs.check-release.outputs.new_version }}"
          echo ""
          echo "  ğŸ”— Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.check-release.outputs.new_version }}"
          echo "  ğŸ“š Crates.io: https://crates.io/crates/motherduck-sync"
